# Eriri 产品设计方案

## 产品定位

Eriri 是一款专为 macOS（M 系列芯片）设计的本地漫画与电子书阅读器，支持外接移动硬盘存储，提供轻量级、实时读取的阅读体验。

## 核心设计原则

- 资源数据不缓存，实时从文件系统读取
- 仅缓存元数据（阅读进度、设置等）
- 两层结构：Library → Comic/Book
- 移动硬盘友好设计

## 功能设计

### 1. Library 管理

#### 1.1 导入机制

**漫画 Library**

- 扫描第一层子文件夹作为 Comic
- 每个 Comic 文件夹包含图片文件
- 支持格式：jpg/jpeg/png/webp/gif

**电子书 Library**

- 扫描第一层的电子书文件
- 支持格式：epub

**导入策略**

- 允许导入多个文件夹作为不同 Library
- 保存文件夹的绝对路径
- 记录卷标（Volume Name）和磁盘 UUID，用于磁盘重新挂载时的路径匹配

#### 1.2 路径管理（核心痛点）

**问题场景**

- 移动硬盘拔出后重新插入，挂载点可能变化
- 用户手动移动了文件夹位置
- 磁盘名称或盘符改变

**解决方案**

- 同时保存路径、卷标和 UUID 三重信息
- 优先匹配绝对路径，失败则通过卷标+UUID 重新定位
- 提供手动"重新定位"功能，让用户指定新路径
- 保留不可用 Library 的记录，不自动删除

#### 1.3 Library 状态

**两种状态**

- 可用：路径存在且可访问
- 不可用：磁盘未连接或路径不存在

**状态处理**

- 不可用的 Library 保留在列表中，显示为灰色
- 点击提示用户连接磁盘
- 磁盘重新连接时自动恢复可用状态

#### 1.4 增量刷新

**触发时机**

- App 启动时
- 用户手动刷新
- 检测到磁盘挂载事件

**刷新逻辑**

- 对比文件系统与本地记录
- 新增内容：自动添加
- 删除内容：标记为"已删除"，保留阅读进度
- 修改内容：更新元数据

### 2. 漫画阅读

#### 2.1 图片排序

**默认策略**

- 按文件名自然排序（1 → 2 → 10，而非 1 → 10 → 2）
- 忽略大小写

**边界处理**

- 文件夹内包含非图片文件：自动过滤
- 损坏图片：显示占位图，允许跳过

#### 2.2 阅读模式

**单页模式**

- 一次显示一张图片
- 适合竖版漫画

**双页模式**

- 一次显示两张图片
- 从右到左或从左到右（可配置）
- 适合跨页漫画

**配置存储**

- 阅读模式、翻页方向保存到单个 Comic 级别
- 不同漫画可独立配置

#### 2.3 阅读进度

**保存内容**

- 当前页码
- 当前阅读模式
- 滚动位置（滚动模式）
- 最后阅读时间

**保存时机**

- 翻页时
- 退出时
- 定时自动保存（避免异常退出丢失）

**容错机制**

- 同时保存文件名和页码
- 文件名匹配优先，失败则使用页码
- 处理图片增删导致的页码错位

### 3. 电子书阅读

#### 3.1 格式支持

epub

#### 3.2 阅读功能

**基础功能**

- 分页模式和滚动模式
- 字体、字号、行高调节，能够使用系统字体
- 背景主题（白天、夜间、护眼）
- 目录导航和章节跳转

**阅读进度**

- 保存章节位置
- 保存阅读百分比
- 保存最后阅读时间

**容错机制**

- 检测文件 hash，识别文件替换
- 文件更新后尝试通过章节标题恢复进度

### 4. 标签系统（可选功能）

#### 4.1 与 macOS 标签集成

**集成方式**

- 读取和写入 macOS 文件系统的标签属性
- 漫画：对文件夹添加标签
- 电子书：对文件添加标签

**双向同步**

- App 读取：启动和刷新时从文件系统读取
- App 写入：在 App 内操作标签时同步到 Finder

#### 4.2 标签功能

**基础操作**

- 添加标签
- 删除标签
- 按标签筛选内容

**技术考虑**

- 需要完全磁盘访问权限
- 提供权限申请引导
- 处理同名标签的合并

### 5. 数据持久化

#### 5.1 存储内容

**Library 信息**

- 名称、路径、卷标、UUID
- 类型（漫画/电子书）
- 创建和扫描时间

**Comic/Book 信息**

- 名称、路径、所属 Library
- 页数/章节数
- 封面路径
- 删除标记

**阅读进度**

- 当前位置（页码/CFI）
- 阅读模式
- 进度百分比
- 最后阅读时间

**标签信息（可选）**

- 标签名称和颜色
- 关联的 Comic/Book

#### 5.2 存储方案

使用本地数据库存储元数据，配置文件存储在 macOS 标准应用支持目录。

### 6. 性能设计

#### 6.1 加载策略

**列表页**

- 懒加载封面，仅加载可视区域
- 虚拟滚动优化长列表

**阅读页**

- 漫画：预加载当前页 + 前后各 2 页
- 电子书：预加载当前章节 + 下一章节
- 离开阅读页时清理缓存

#### 6.2 内存管理

- 限制最大缓存大小
- 自动清理不再使用的图片缓存
- 监控内存使用，必要时主动释放

### 7. 用户体验设计

#### 7.1 导航结构

- 侧边栏显示所有 Library
- 主区域显示选中 Library 的内容网格
- 点击进入阅读页面

#### 7.2 阅读体验

**沉浸式阅读**

- 工具栏自动隐藏
- 鼠标移动时显示控制栏
- 全屏模式支持

**快捷操作**

- 键盘快捷键支持
- 点击屏幕边缘翻页
- 进度指示和快速跳转

#### 7.3 反馈机制

- 加载状态提示
- 操作成功/失败提示
- 错误友好提示（如磁盘未连接）

### 8. 错误处理

#### 8.1 常见错误场景

**磁盘相关**

- 磁盘拔出：保留记录，标记不可用
- 路径变更：提供重新定位
- 权限不足：引导申请权限

**文件相关**

- 文件损坏：跳过并提示
- 空文件夹：友好提示
- 文件删除：保留进度，标记已删除

#### 8.2 数据安全

- 数据库定期自动备份
- 配置文件损坏时恢复默认
- 异常退出时保护阅读进度

### 9. 开发阶段规划

#### Phase 1（MVP 核心功能）

- Library 导入与管理
- 移动硬盘支持（路径管理）
- 漫画基础阅读（单页模式）
- 阅读进度保存与恢复

#### Phase 2（完善体验）

- 电子书 epub 支持
- 多种阅读模式（双页、滚动）
- 快捷键和手势支持
- 性能优化

#### Phase 3（可选增强）

- macOS 标签集成
- 更多阅读设置选项

## 设计亮点

1. **移动硬盘友好**：通过多重路径识别机制，完美适配外置存储
2. **轻量级设计**：不缓存资源数据，保持 App 体积小巧
3. **容错能力强**：全面考虑文件变更、磁盘拔插等异常场景
4. **系统集成深**：利用 macOS 原生标签系统，无需额外数据管理
5. **阅读体验优**：多种模式、进度保存、沉浸式阅读

## 技术约束

- 仅支持 macOS M 系列芯片
- 不考虑跨平台兼容
- 不实现云同步功能
- 不缓存大文件资源
